import { useEffect, useRef, useState } from "react";
import { Message } from "../interfaces/Message";
import { Outlet, useNavigate, useOutlet, useParams } from "react-router-dom";
import ChatCloud from "../components/ChatCloud";
import ChatTextField from "../components/ChatTextField";
import {
  IoArrowBack,
  IoEllipsisVertical,
  IoEllipsisVerticalOutline,
} from "react-icons/io5";
import useRoom from "../hooks/useRoom";
import useAuth from "../hooks/useAuth";
import useMessage from "../hooks/useMessage";
import ChatNotification from "../components/ChatNotification";
import ChatDateRule from "../components/ChatDateRule";
import useDateTimeHelper from "../hooks/useDateTimeHelper";
import Music from "../components/Music";
import useSocket from "../hooks/useSocket";
import ChatMusicCloud from "../components/ChatMusicCloud";
import Lottie from "react-lottie";
import chatLoader from "../assets/chat_loader_lottie.json";
import ChatVotingCloud from "../components/ChatVotingCloud";

export default function ChatRoom() {
  const messagesSectionRef = useRef<HTMLDivElement>(null);
  const [messages, setMessages] = useState<Message[]>([]);
  const navigate = useNavigate();
  const { user } = useAuth();
  const { sendMessage } = useMessage();
  const { midFromDate, dateFromMid, formatDate } = useDateTimeHelper();
  const [musicModalOpen, setMusicModalOpen] = useState(false);
  const { socket } = useSocket();
  const { room, roomLoading, voting } = useRoom();
  const params = useParams();
  const [messageList, setMessageList] = useState<any>([]);
  const outlet = useOutlet();

  const handleOnSend = (value: string) => {
    setMessages([
      ...messages,
      {
        mid: midFromDate(new Date()),
        type: "text",
        content: value,
        sender: user?.uid || "",
      },
    ]);

    if (socket)
      socket.emit("send_message", {
        message: {
          mid: midFromDate(new Date()),
          type: "text",
          content: value,
          sender: user?.uid || "",
        },
        rid: params.rid,
      });

    sendMessage(
      { type: "text", content: value, sender: user?.uid || "" },
      params.rid || ""
    );
  };

  const scrollToBottom = () => {
    messagesSectionRef.current?.scrollIntoView({ behavior: "auto" });
  };

  const handleBackClick = () => {
    navigate(-1);
  };

  const handleOptionsClick = () => {
    navigate(`/${params.rid}/details`);
  };

  const newDayMessage = (prevMessage: Message, newMessage: Message) => {
    return (
      dateFromMid(prevMessage.mid || "").getDate() !==
      dateFromMid(newMessage.mid || "").getDate()
    );
  };

  const createMessageList = () => {
    let newMessageList: any[] = [];

    messages.forEach((message, i) => {
      if (i === 0 || newDayMessage(messages[i - 1], message)) {
        newMessageList.push(
          <ChatDateRule
            key={i}
            date={formatDate(dateFromMid(message?.mid || ""))}
          />
        );
      }
      if (message.type === "text")
        newMessageList.push(<ChatCloud key={message.mid} message={message} />);
      else if (message.type === "notification")
        newMessageList.push(
          <ChatNotification key={message.mid} message={message} />
        );
      else if (message.type === "music")
        newMessageList.push(
          <ChatMusicCloud key={message.mid} message={message} />
        );
    });

    setMessageList(newMessageList);
  };

  const handleReceiveMessageSocket = ({
    message,
    rid,
  }: {
    message: Message;
    rid: string;
  }) => {
    if (rid === params.rid) {
      setMessages([...messages, message]);
    }
  };

  useEffect(() => {
    if (socket) socket.on("receive_message", handleReceiveMessageSocket);
    return () => {
      socket?.off("receive_message", handleReceiveMessageSocket);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [socket, messages, params]);

  useEffect(() => {
    room?.messages && setMessages(room.messages);
  }, [room]);

  useEffect(() => {
    createMessageList();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [messages]);

  useEffect(() => {
    scrollToBottom();
  }, [messageList, voting, outlet]);

  if (roomLoading)
    return (
      <div className="h-full bg-blue-900/70 w-full flex justify-center items-center">
        <span className="opacity-70">
          <Lottie
            options={{
              loop: true,
              autoplay: true,
              animationData: chatLoader,
              rendererSettings: {
                preserveAspectRatio: "xMidYMid slice",
              },
            }}
            height={150}
            width={150}
          />
        </span>
      </div>
    );
  else if (outlet) return <Outlet />;
  else
    return (
      <div className="w-full h-full flex flex-col">
        <div className="w-full h-16 border-b border-indigo-300/30 bg-blue-900/90 px-2 py-1 flex items-center">
          <button
            className="text-2xl hover:text-white duration-100 sm:hidden"
            onClick={handleBackClick}
          >
            <IoArrowBack />
          </button>
          <img
            alt="room"
            src={room?.image_url}
            className="h-10 rounded-full mx-2"
          />
          <h2>{room?.name}</h2>

          <button
            onClick={handleOptionsClick}
            className="ml-auto text-2xl p-2 hover:bg-white/10 rounded-full group duration-100"
          >
            <IoEllipsisVerticalOutline className="group-hover:hidden" />
            <IoEllipsisVertical className="hidden group-hover:flex text-white" />
          </button>
        </div>
        <div className="h-full bg-blue-900/70 w-full p-2 pr-1 sm:p-4 flex flex-col justify-between relative z-10">
          <div className="w-full h-[calc(100vh-16.5rem)] flex flex-col overflow-x-hidden overflow-y-scroll mb-2 relative z-10">
            {messageList}
            <ChatVotingCloud />
            <div ref={messagesSectionRef} />
          </div>
          <ChatTextField onSend={handleOnSend} />
          <Music
            musicModalOpen={musicModalOpen}
            setMusicModalOpen={setMusicModalOpen}
          />
        </div>
      </div>
    );
}
